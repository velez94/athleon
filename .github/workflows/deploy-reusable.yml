name: Reusable Deployment Workflow

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      account_id_secret:
        required: true
        type: string
    secrets:
      HUB_ACCOUNT_ID:
        required: true
      DEV_ACCOUNT_ID:
        required: false
      STG_ACCOUNT_ID:
        required: false
      PROD_ACCOUNT_ID:
        required: false

env:
  NODE_VERSION: '24'
  AWS_REGION: us-east-2

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: self-hosted
    environment: ${{ inputs.environment }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.HUB_ACCOUNT_ID }}:role/GitHubActionsHubRole-prd  
          role-session-name: GitHubActions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com
          output-env-credentials: true

      - name: Assume Spoke Role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets[inputs.account_id_secret] }}:role/GitHubActionsSpokeDeploymentRole-prd
          role-session-name: GitHubActions-Spoke-${{ inputs.environment }}-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            frontend/package-lock.json
            layers/athleon-shared/package-lock.json
          
      - name: Install CDK
        run: npm install -g aws-cdk

      - name: Install backend dependencies
        run: npm install --include=dev

      - name: Build layer
        run: npm run build:layer

      - name: CDK diff
        run: npm run diff
        env:
          CI: true
          ENVIRONMENT: ${{ inputs.environment }}

      - name: Deploy using existing script
        id: cdk-deploy
        run: npm run deploy
        env:
          CI: true
          ENVIRONMENT: ${{ inputs.environment }}

      - name: Get stack outputs
        id: outputs
        run: |
          STACK_NAME="Athleon-${{ inputs.environment }}"
          API_URL=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' --output text)
          echo "api-url=${API_URL%/}" >> $GITHUB_OUTPUT
          echo "user-pool-id=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' --output text)" >> $GITHUB_OUTPUT
          echo "user-pool-client-id=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`UserPoolClientId`].OutputValue' --output text)" >> $GITHUB_OUTPUT
          echo "s3-bucket=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`FrontendBucket`].OutputValue' --output text)" >> $GITHUB_OUTPUT
          echo "cloudfront-id=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`FrontendDistributionId`].OutputValue' --output text)" >> $GITHUB_OUTPUT

      - name: Create frontend config
        run: |
          cd frontend
          cat > src/aws-config.json << EOF
          {
            "environment": "${{ inputs.environment }}",
            "apiUrl": "${{ steps.outputs.outputs.api-url }}",
            "userPoolId": "${{ steps.outputs.outputs.user-pool-id }}",
            "userPoolClientId": "${{ steps.outputs.outputs.user-pool-client-id }}",
            "region": "${{ env.AWS_REGION }}"
          }
          EOF

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          REACT_APP_ENVIRONMENT=${{ inputs.environment }} \
          REACT_APP_API_URL=${{ steps.outputs.outputs.api-url }} \
          REACT_APP_USER_POOL_ID=${{ steps.outputs.outputs.user-pool-id }} \
          REACT_APP_USER_POOL_CLIENT_ID=${{ steps.outputs.outputs.user-pool-client-id }} \
          REACT_APP_REGION=${{ env.AWS_REGION }} \
          npm run build

      - name: Deploy to S3
        run: |
          aws s3 sync frontend/build/ s3://${{ steps.outputs.outputs.s3-bucket }} --delete

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ steps.outputs.outputs.cloudfront-id }} --paths "/*"