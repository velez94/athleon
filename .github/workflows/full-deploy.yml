name: Full Athleon Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  AWS_REGION: us-east-2

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: self-hosted
    strategy:
      matrix:
        environment: [dev]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.HUB_ACCOUNT_ID }}:role/GitHubActionsHubRole-prd  
          role-session-name: GitHubActions-${{ github.run_id }}
          aws-region: us-east-1

      - name: Assume Spoke Role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets[format('{0}_ACCOUNT_ID', matrix.environment)] }}:role/GitHubActionsSpokeDeploymentRole-${{ github.event.repository.default_branch == 'main' && 'prd' || 'dev' }}
          role-session-name: GitHubActions-Spoke-${{ matrix.environment }}-${{ github.run_id }}
          aws-region: us-east-1
          role-chaining: true

          
      - name: Install CDK
        run: npm install -g aws-cdk

      - name: Install dependencies
        run: npm ci

      - name: Deploy CDK stack
        id: cdk-deploy
        run: |
          cdk deploy Athleon-${{ matrix.environment }} \
            --context environment=${{ matrix.environment }} \
            --require-approval never

      - name: Get stack outputs
        id: outputs
        run: |
          STACK_NAME="Athleon-${{ matrix.environment }}"
          echo "api-url=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' --output text)" >> $GITHUB_OUTPUT
          echo "user-pool-id=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' --output text)" >> $GITHUB_OUTPUT
          echo "user-pool-client-id=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`UserPoolClientId`].OutputValue' --output text)" >> $GITHUB_OUTPUT
          echo "s3-bucket=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`FrontendBucket`].OutputValue' --output text)" >> $GITHUB_OUTPUT
          echo "cloudfront-id=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`FrontendDistributionId`].OutputValue' --output text)" >> $GITHUB_OUTPUT

      - name: Create frontend config
        run: |
          cd frontend
          cat > src/aws-config.json << EOF
          {
            "environment": "${{ matrix.environment }}",
            "apiUrl": "${{ steps.outputs.outputs.api-url }}",
            "userPoolId": "${{ steps.outputs.outputs.user-pool-id }}",
            "userPoolClientId": "${{ steps.outputs.outputs.user-pool-client-id }}",
            "region": "${{ env.AWS_REGION }}"
          }
          EOF

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          REACT_APP_ENVIRONMENT=${{ matrix.environment }} \
          REACT_APP_API_URL=${{ steps.outputs.outputs.api-url }} \
          REACT_APP_USER_POOL_ID=${{ steps.outputs.outputs.user-pool-id }} \
          REACT_APP_USER_POOL_CLIENT_ID=${{ steps.outputs.outputs.user-pool-client-id }} \
          REACT_APP_REGION=${{ env.AWS_REGION }} \
          npm run build

      - name: Deploy to S3
        run: |
          aws s3 sync frontend/build/ s3://${{ steps.outputs.outputs.s3-bucket }} --delete

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ steps.outputs.outputs.cloudfront-id }} --paths "/*"